(function(e,t){"use strict";e.Annotater=function(e){if(typeof e==="string"){e={name:e}}for(var t in e){this[t]=e[t]}if(this.modelReplaces){this._insertModel()}this._collectVariables();this._processMatches();this._replaceTextNodes();return this};e.Annotater.prototype={inside:"body",name:null,nameBecomes:"{name}",tooltip:null,varClass:"annotated-variable",modelReplaces:null,modelPrompt:null,autoStyle:true,_collectVariables:function(){this._vars=[];var e=[];var t=this;var n=document.querySelector(this.inside);i(n);for(var a in e){t._extractMatchingTextNode(e[a])}function i(n){if(!n){return}for(var a=0;a<n.childNodes.length;a++){if(n.childNodes[a].nodeType==3&&n.childNodes[a].data.match(t.name)){e.push(n.childNodes[a])}else if(t._okayToEnterNode(n.childNodes[a])&&n.childNodes[a].textContent.match(t.name)){i(n.childNodes[a])}}}},_extractMatchingTextNode:function(e){var t=e;var n=null;var a=null;var i=null;var o=null;while(t.data.match(this.name)){a=t.data.match(this.name)[0];i=a.length;n=t.data.indexOf(a);if(n>0){o=t.splitText(n)}else{o=t}t=o.splitText(i);this._vars.push({textNode:o,name:o.data})}},_replaceTextNodes:function(){var e=null;var t=null;for(var n in this._vars){e=this._vars[n].textNode.parentNode;t=this._vars[n].container;e.insertBefore(t,this._vars[n].textNode);e.removeChild(this._vars[n].textNode)}},_insertModel:function(){var e=this;var t=null;var n=null;var a=document.createElement("input");var o=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null,null);while(o.nextNode()){if(o.currentNode.data.match(this.modelReplaces)){t=o.currentNode;break}}if(!t){return}var r=t.data.match(this.modelReplaces);var s=t.data.indexOf(r);var l=r[0].length;if(s>0){n=t.splitText(s)}else{n=cursor}a.setAttribute("type","text");a.setAttribute("width","25");n.splitText(l);n.parentNode.insertBefore(a,n);n.parentNode.insertBefore(document.createTextNode(this.modelPrompt),a);n.parentNode.removeChild(n);a.addEventListener("keyup",function(t){var n=t.target.value;for(var a in this._vars){if(n.length>0){this._vars[a].varTag.innerHTML=i(e.nameBecomes,{name:n})}else{this._vars[a].varTag.innerHTML=i(e.nameBecomes,{name:this._vars[a].name})}}}.bind(this))},_processMatches:function(){var e=null;for(var t in this._vars){e=this._vars[t];e.container=document.createElement("span");e.varTag=document.createElement("span");e.toolTip=document.createElement("div");e.container.appendChild(e.varTag);e.varTag.innerHTML=this._flexyGen(e.name,this.nameBecomes);e.varTag.setAttribute("class",this._flexyGen(e.name,this.varClass));e.varTag.dataset.annotated="true";if(this.tooltip){e.toolTip.innerHTML=this._flexyGen(e.name,this.tooltip);e.container.appendChild(e.toolTip);e.varTag.style.cursor="none";if(this.autoStyle){e.varTag.style.textDecorationStyle="dotted";e.varTag.style.textDecorationColor="rgba(0,0,0,.5)";e.varTag.style.textDecorationLine="underline";e.container.style.position="relative";e.container.style.overflow="visible";e.toolTip.style.transitionDuration=".5s";e.toolTip.style.position="absolute";e.toolTip.style.background="rgba(255,255,255,.9)";e.toolTip.style.pointerEvents="none";e.toolTip.style.padding="4px";e.toolTip.style.paddingTop="30px";e.toolTip.style.minWidth="250px";e.toolTip.style.top="-10px";e.toolTip.style.left="-10px";e.container.style.zIndex=0;e.toolTip.style.zIndex=5;e.varTag.style.position="relative";e.varTag.style.zIndex=100}n.call(e,e,this);e.container.addEventListener("mouseleave",n.bind(e,e,this));e.container.addEventListener("mouseover",a.bind(e,e,this))}}},_flexyGen:function(e,t){if(!t){return e}else if(typeof t==="string"){var n=e.replace(this.name,function(e){return i(t,{name:e,capture:Array.prototype.slice.call(arguments,1,arguments.length-2)})});return n}else if(typeof t==="function"){return e.replace(this.name,t)}},_okayToEnterNode:function(e){var t={tags:["var","iframe","script","canvas","svg","textarea","input"],classes:["rlv-no-descend"]};if(e.nodeType!==1){return false}if(e.dataset.annotated==="true"){return false}for(var n=0;n<t.tags.length;n++){if(e.nodeName.toUpperCase()==t.tags[n].toUpperCase()){return false}}for(var n=0;n<t.classes.length;n++){if(e.classList&&e.classList.contains(t.classes[n])){return false}}return true}};function n(e,t){if(t.autoStyle){this.toolTip.style.opacity=0;this.toolTip.style.pointerEvents="none";this.varTag.style.textShadow="none";this.timeout=setTimeout(function(){e.toolTip.style.display="none"},1500)}this.varTag.classList.add("tooltip-closed");this.varTag.classList.remove("tooltip-open")}function a(e,t){var n=+window.getComputedStyle(this.varTag,null).lineHeight.replace(/[^0-9.]/g,"")+10;if(t.autoStyle){clearTimeout(this.timeout);e.toolTip.style.display="block";this.toolTip.style.opacity=1;this.toolTip.style.pointerEvents="all";this.toolTip.style.paddingTop=n+"px";this.varTag.style.textShadow="yellow 0 0 2px";if(this.varTag.getBoundingClientRect().x>window.innerWidth/2){this.toolTip.style.right="-10px";this.toolTip.style.left="unset"}else{this.toolTip.style.left="-10px";this.toolTip.style.right="unset"}}this.varTag.classList.add("tooltip-open");this.varTag.classList.remove("tooltip-closed")}function i(e,t){return e.replace(/\{([^}]+)\}/g,function(e,n){var a=n.split(/[."'\[\]]+/);if(a[a.length-1]===""){a.pop()}var i=t;var o=null;while(a.length>0){if(i===undefined){return undefined}o=a.shift();if(o.match(/^[0-9]+$/)){o*=1}i=i[o]}return i})}function o(e){if(e instanceof RegExp){return e}else if(typeof e==="string"){return new RegExp("\\b"+e.trim()+"\\b","g")}else{throw new Error("can't build regex from "+e)}}e.annotater=function(e){var t=new Annotater(e);return t}})(window,document);
